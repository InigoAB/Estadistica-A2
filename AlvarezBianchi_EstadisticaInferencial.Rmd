---
title: "A2 - Estadística inferencial: tests de hipótesis de una y dos muestras"
author: "Iñigo Alvarez Bianchi"
date: "23/11/2020"
output:
  html_document:
    toc: yes
  pdf_document:
    toc: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load_libraries, message=FALSE, warning=FALSE}
# Empiezo cargando los paquetes que usaré:
library(knitr)
library(gridExtra)
library(tidyverse)
library(data.table)
```

# 1 Estadística descriptiva y visualización

Cargo los datos, visualizo las primeras filas y compruebo la estructura de los datos para ver que se han interpretado correctamente.
```{r 1, warning=FALSE}
CCS <- read.csv("ChildCarSeats_clean.csv", stringsAsFactors=TRUE)
head(CCS)
str(CCS)
```

Veo que los datos numéricos aparecen como tal y los de texto como factor, tal como necesito.

```{r 1.2, message=FALSE, warning=FALSE}
summary(CCS)
```


Ahora voy a hacer un gráfico para cada variable.
```{r 1.3}
p1 <- qplot(Sales, data=CCS, bins=20)
p2 <- qplot(CompPrice, data=CCS, bins=20)
p3 <- qplot(Income, data=CCS, bins=20)
p4 <- qplot(Advertising, data=CCS, bins=20)
p5 <- qplot(Population, data=CCS, bins=20)
p6 <- qplot(Price, data=CCS, bins=20)
p7 <- qplot(ShelveLoc, data=CCS)
p8 <- qplot(Age, data=CCS, bins=20)
p9 <- qplot(Education, data=CCS, bins=20)
p10 <- qplot(Urban, data=CCS)
p11 <- qplot(US, data=CCS)
grid.arrange(p1, p2, p3, p4, p5, p6, p7, p8, p9, p10, p11)
```

Se pueden ver varios histogramas y diagramas de barras.

Sales, CimpPrice y Price parecen seguir una distribución similar a la normal. Pero esto no parece ocurrir con el resto de variables.

La mayor parte de los clientes son Urbanos y de Estados Unidos.


# 2 Intervalo de confianza de la media poblacional de las ventas

¿Cuál es el valor promedio de las ventas en las tiendas?

## 2.1 Cálculo

```{r 2.1}
icm <- function(pobl, NC=0.95) {
  alfa <- 1-NC
  sd <- sd(pobl)
  n <- length(pobl)
  SE <- sd / sqrt(n)
  z <- qt(alfa/2, df=n-1, lower.tail=FALSE)
  L <- mean(pobl) - z*SE
  U <- mean(pobl) + z*SE
  round(c(L,U), 2)
}

ICM_sales <- icm(CCS$Sales)
ICM_sales
```

Intervalo de la media de ventas (con un nivel de confianza del 95%): [`r icm(CCS$Sales)`]

```{r 2.1.1}
t.test(CCS$Sales, conf.level = 0.95)
```

Compruebo que aplicando la función t.test el resultado que me da es equivalente.

## 2.2 Interpretación
La media de ventas en miles de unidades se encuentra en el intervalo [`r icm(CCS$Sales)`] para un nivel de confianza del 95%.

## 2.3 Intervalo de confianza de la media poblacional de Sales en USA y fuera de USA
```{r 2.3}
ICM_salesUSA <- icm(CCS[CCS$US=="Yes",]$Sales)
ICM_salesUSA
ICM_salesFueraUSA <- icm(CCS[CCS$US=="No",]$Sales)
ICM_salesFueraUSA
```

Podemos decir con un 95% de confianza que el valor promedio de las ventas en las tiendas de Estados Unidos se encuentra en: [`r icm(CCS[CCS$US=="Yes",]$Sales)`]

Podemos decir con un 95% de confianza que el valor promedio de las ventas en las tiendas de fuera de Estados Unidos se encuentra en: [`r icm(CCS[CCS$US=="No",]$Sales)`]


# 3 Ventas del producto en USA y fuera de USA

¿Venden más las tiendas de USA que las de fuera de USA?

## 3.1 Hipótesis nula y alternativa

$\left\{
\begin{array}{llcrr}
H_{0}: &  \mu_1=\mu_2 & \ o \ & \ H_{0}: & \mu_{1}-\mu_{2}\leq0\\
H_{1}: & \mu_1>\mu_2 & \ o \ & \ H_{1}: & \mu_{1}-\mu_{2}>0
\end{array}
\right.$

## 3.2 Test a aplicar

```{r 3.2.1}
length(CCS[CCS$US=="Yes",]$Sales)
length(CCS[CCS$US=="No",]$Sales)
```

Por el teorema del límite central se puede considerar que el contraste de hipótesis sobre la media se aproxima a la distribución normal ya que el n para las ventas en USA es `r length(CCS[CCS$US=="Yes",]$Sales)` y fuera de USA es `r length(CCS[CCS$US=="No",]$Sales)`, ambas superiores a 30.

Para ilustrarlo usaré el test de Shapiro-Wilk y la visualización gráfica para las ventas en Estados Unidos:

```{r 3.2.2}
shapiro.test(CCS[CCS$US=="Yes",]$Sales)
qqnorm(CCS[CCS$US=="Yes",]$Sales)
qqline(CCS[CCS$US=="Yes",]$Sales)
```

No se puede rechazar la hipótesis nula de normalidad por el test Shapiro-Wilk y en la representación gráfica se ve que los puntos son cercanos a la normalidad por lo que asumimos normalidad.

Y para las ventas fuera de Estados Unidos:
```{r 3.2.3}
shapiro.test(CCS[CCS$US=="No",]$Sales)
qqnorm(CCS[CCS$US=="No",]$Sales)
qqline(CCS[CCS$US=="No",]$Sales)
```

Para las ventas fuera de Estados Unidos también asumimos normalidad ya que el test Shapiro-Wilk no nos permite rechazar la hipótesis nula de normalidad y la representación gráfica nos muestra que es cercana a la normalidad.

Ahora hay que hacer un test de homoscedasticidad:

```{r 3.2.4}
homoscedasticidad <- function(pobl1, pobl2, NC=0.95) {
  alfa <- 1-NC
  mean1 <- mean(pobl1); n1 <- length(pobl1); s1 <- sd(pobl1)
  mean2 <- mean(pobl2); n2 <- length(pobl2); s2 <- sd(pobl2)
  fobs<-s1^2 / s2^2
  fcritL <- qf(alfa/2, df1=n1-1, df2=n2-2)
  fcritU <- qf(1- alfa/2, df1=n1-1, df2=n2-2)
  pvalue <- min(pf( fobs, df1=n1-1, df2=n2-2, lower.tail=FALSE ), pf( fobs, df1=n1-1, df2=n2-2))*2
  data.table(fobs, fcritL, fcritU, pvalue)
}

homoscedasticidad(CCS[CCS$US=="Yes",]$Sales, CCS[CCS$US=="No",]$Sales)
```

El valor observado cae fuera de la zona de aceptación y el p-valor obtenido es menor que α por lo que no podemos asumir igualdad de varianzas.

Tengo que aplicar un test unilateral por la derecha sobre la media de dos poblaciones independientes con varianzas desconocidas diferentes.

## 3.3 Cálculos

Creo una función para este tipo de contraste de hipótesis, que acabo de comentar, por lo que la llamo usando sus iniciales: CH_UD_m2pi_vd, con un nivel de confianza por defecto del (1 - α)*100 = 95%.

```{r 3.3.1}
CH_UD_m2pi_vd <- function(pobl1, pobl2, NC=0.95) {
  alfa <- 1-NC
  mean1 <- mean(pobl1); n1 <- length(pobl1); s1 <- sd(pobl1)
  mean2 <- mean(pobl2); n2 <- length(pobl2); s2 <- sd(pobl2)
  # Estadístico de contraste
  tobs <- (mean1-mean2) / (sqrt(((s1^2)/n1) + ((s2^2)/n2)))
  # Grados de libertad u
  u <- ((((s1^2)/n1)+((s2^2)/n2))^2)/(((((s1^2)/n1)^2)/(n1-1))+((((s2^2)/n2)^2)/(n2-1)))
  # Región de aceptación
  tcritL <- qt(alfa, df=u, lower.tail=FALSE)
  # Cálculo del valor p
  pvalue <-pt( tobs, df=u, lower.tail=FALSE)
  data.table(L="INF", U=tcritL, tobs, pvalue)
}

# Ejecuto la función para cada una de estas poblaciones y con el nivel de confianza (NC) por defecto
CH_UD_m2pi_vd(CCS[CCS$US=="Yes",]$Sales, CCS[CCS$US=="No",]$Sales)
```

Ejecuto la función de R t.test como comprobación:
```{r 3.3.2}
t.test(CCS[CCS$US=="Yes",]$Sales, CCS[CCS$US=="No",]$Sales, alternative="greater", var.equal=FALSE)
```

El valor p es muy pequeño por lo que rechazo la hipótesis nulas de que las ventas en Estados Unidos y fuera son iguales. Puedo concluir que las ventas en Estados Unidos son más altas con una confianza del 95%.

## 3.4 Conclusión

El valor observado (tobs) es 4.97 y la zona de aceptación de la hipótesis nula es ($-\infty$, 1.649162], por lo que cae fuera así que podemos rechazarla y quedarnos con la alternativa.

También veo que el valor p es mucho más pequeño que $\alpha$, por lo que hay que rechazar la hipótesis nula de que las ventas son iguales en las tiendas de Estados Unidos y las de fuera y aceptar la hipótesis alternativa de que las tiendas en Estados Unidos venden más que las de fuera. 

En el apartado anterior hemos visto que los intervalos de confianza no se solapaban y que el intervalo de la media de ventas de las tiendas de Estados Unidos es superior por lo que sospechaba que se podría decir que las tiendas de Estados Unidos venden más, como se ha confirmado ahora.


# 4 Ventas en zonas urbanas y rurales

¿Son diferentes las ventas de zonas urbanas en comparación con las ventas de zonas rurales?

## 4.1 Hipótesis nula y alternativa

$H_{0}: \mu_{1}=\mu_{2}$ o $H_{0}: \mu_{1}-\mu_{2}=0$

$H_{1}: \mu_{1}≠\mu_{2}$ o $H_{1}: \mu_{1}-\mu_{2}≠0$

## 4.2 Test a aplicar

```{r 4.2.1}
length(CCS[CCS$Urban=="Yes",]$Sales)
length(CCS[CCS$Urban=="No",]$Sales)
```

Por el teorema del límite central se puede considerar que el contraste de hipótesis sobre la media se aproxima a la distribución normal ya que el n para las ventas en zonas urbanas es `r length(CCS[CCS$Urban=="Yes",]$Sales)` y en zonas rurales es `r length(CCS[CCS$Urban=="No",]$Sales)`, ambas superiores a 30.

Para ilustrarlo usaré el test de Shapiro-Wilk y la visualización gráfica para las ventas en zonas urbanas:

```{r 4.2.2}
shapiro.test(CCS[CCS$Urban=="Yes",]$Sales)
qqnorm(CCS[CCS$Urban=="Yes",]$Sales)
qqline(CCS[CCS$Urban=="Yes",]$Sales)
```

No se puede rechazar la hipótesis nula de normalidad por el test Shapiro-Wilk y en la representación gráfica se ve que los puntos son cercanos a la normalidad por lo que asumimos normalidad.

Y para las ventas fuera de Estados Unidos:
```{r 4.2.3}
shapiro.test(CCS[CCS$Urban=="No",]$Sales)
qqnorm(CCS[CCS$Urban=="No",]$Sales)
qqline(CCS[CCS$Urban=="No",]$Sales)
```

En zonas rurales también asumimos normalidad.

Ahora hay que hacer un test de homoscedasticidad:

```{r 4.2.4}
homoscedasticidad(CCS[CCS$Urban=="Yes",]$Sales, CCS[CCS$Urban=="No",]$Sales)
```

Como el valor observado cae en la zona de aceptación y el p-valor es superior a α=0.05 acepto la homoscedasticidad, es decir, acepto que las varianzas son iguales.

## 4.3 Cálculos

```{r 4.3.1}
CH_UD_m2pi_vi <- function(pobl1, pobl2, NC=0.95) {
  alfa <- 1-NC
  mean1 <- mean(pobl1); n1 <- length(pobl1); s1 <- sd(pobl1)
  mean2 <- mean(pobl2); n2 <- length(pobl2); s2 <- sd(pobl2)
  S <- sqrt( ( (n1-1)*s1^2 + (n2-1)*s2^2 ) / (n1+n2-2) )
  # Estadístico de contraste
  tobs <- (mean1-mean2) / (S * sqrt(1/n1 + 1/n2))
  # Región de aceptación
  tcritL <- qt( alfa/2, n1+n2-2)
  tcritU <- qt( 1-alfa/2, n1+n2-2)
  # Cálculo del valor p
  pvalue <-pt( abs(tobs), df=n1+n2-2, lower.tail=FALSE)*2
  data.table(L=tcritL, U=tcritU, tobs, pvalue)
}

# Ejecuto la función para cada una de estas poblaciones y con el nivel de confianza (NC) por defecto
CH_UD_m2pi_vi(CCS[CCS$Urban=="Yes",]$Sales, CCS[CCS$Urban=="No",]$Sales)
```

Uso la función de R t.test como comprobación:
```{r 4.3.2}
t.test(CCS[CCS$Urban=="Yes",]$Sales, CCS[CCS$Urban=="No",]$Sales,var.equal=TRUE)
```

## 4.4 Conclusión

El valor observado sale en la zona de aceptación y el valor p es superior a α, por lo que no puedo rechazar la hipótesis nula de que las ventas son iguales en las tiendas urbanas y las rurales.


# 5 Estrategia de precios

¿Más de la mitad de las tiendas tienen un precio inferior al de la competencia?

## 5.1 Hipótesis nula y alternativa

$H_{0}: p = 0.5$

$H_{1}: p > 0.5$


## 5.2 Tipo de test

Aplicaré un test sobre la proporción para una muestra grande ya que contamos con una muestra grande, de n = `r nrow(CCS)`.

## 5.3 Cálculos

```{r 5.3.1}
CH_prop <- function(x, n, p, NC=0.95) {
  alfa <- 1-NC
  p0 <- p # proporción de la hipótesis
  pobs <- x/n
  zobs <- (pobs-p0)/sqrt((p0*(1-p0))/n)
  zcrit <- qnorm(alfa, lower.tail=FALSE)
  pvalue<- pnorm(zobs, lower.tail=FALSE)
  data.table(zobs, zcrit, pvalue)
}

CH_prop(x=sum(CCS$Price<CCS$CompPrice), n=length(CCS$Price), p=0.5)
```

Uso la función de R prop.test a modo de comprobación:
```{r 5.3.2}
prop.test(x=sum(CCS$Price<CCS$CompPrice), n=length(CCS$Price), p=0.5, alternative="greater", correct=FALSE)
```

## 5.4 Conclusión

El valor crítico ha caído en 1.64 lo que implica que la zona de aceptación es ($-\infty$, 1,64] por lo que con un valor observado 7.04, que cae fuera, rechzamos la hipótesis nula. El valor p es muy pequeño, inferior a la significación fijada del 0.05 así que esto también nos lleva a rechazar la hipótesis nula.

Puedo concluir que más de la mitad de las tiendas tienen un precio inferior al de la competencia con un nivel de confianza del 95%.


# 6 Diferencias en la estrategia de precios

¿Hay una estrategia de precios diferente en las tiendas de USA en relación a las de fuera de USA?

¿La proporción de casos en los que el precio de la tienda es más bajo que la competencia (estrategia de precios bajos) es diferente en las tiendas de USA que en las tiendas fuera de USA?

## 6.1 Hipótesis nula y alternativa

$H_{0}: p_{1} = p_{2}$

$H_{1}: p_{1} ≠ p_{2}$

## 6.2 Tipo de test

Aplicaré un test bilateral sobre la proporción de dos muestras.

## 6.3 Cálculos

```{r 6.3.1}
CH_prop2 <- function(x1, x2, n1, n2, p1, p2, NC=0.95) {
  alfa <- 1-NC
  
  
  
  p0 <- p # proporción de la hipótesis
  pobs <- x/n
  zobs <- (pobs-p0)/sqrt((p0*(1-p0))/n)
  zcrit <- qnorm(alfa, lower.tail=FALSE)
  pvalue<- pnorm(zobs, lower.tail=FALSE)
  data.table(zobs, zcrit, pvalue)
}

#CH_prop2(x=sum(CCS$Price<CCS$CompPrice), n=length(CCS$Price), p=0.5)
```

```{r}
NC <- 0.95
alfa <- 1-NC
x1 <- CCS[CCS$US=="Yes",]    #tiendas de USA
x2 <- CCS[CCS$US=="No",]    #tiendas de fuera
n1 <- length(x1$Price)
n2 <- length(x2$Price)
p1 <- sum(x1$Price<x1$CompPrice)/n1   #proporción de tiendas de USA con el precio más bajo CCS$Price<CCS$CompPrice
p2 <- sum(x2$Price<x2$CompPrice)/n2   #proporción de tiendas de fuera con el precio más bajo
p<- (n1*p1 + n2*p2) / (n1+n2)
zobs <- (p1-p2)/( sqrt(p*(1-p)*(1/n1+1/n2)) )
tcrit.L <- qnorm(alfa/2)
tcrit.U <- qnorm(alfa/2, lower.tail=FALSE)
pvalue<- pnorm( abs(zobs), lower.tail=FALSE )*2
data.table(L=tcrit.L, U=tcrit.U, zobs, pvalue)
```

```{r}
# Validación con prop.test: se construye un data frame que se le pasa > #a prop.test
success<-c(p1*n1, p2*n2)
nn<-c(n1,n2)
pp<-c(p1,p2)
prop.test(success, nn, alternative="two.sided", conf.level = 0.95, correct=FALSE)
```


## 6.4 Conclusión

La estrategia de precios de las tiendas en USA y fuera de USA es la misma, es decir, la proporción de tiendas que venden por debajo del precio de la competencia es la misma en Estados Unidos y fuera. 

Dado que el valor observado cae en la zona de aceptación [-1.96, 1.96] y el valor z es más grande que 1- 0,95, no podemos rechazar la hipótesis nula de que la estrategia de precios es la misma para las tiendas de USA y las de fuera de USA.
